# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

# Trigger pipeline on pushes to main branch
trigger:
- main

# Define agent pool
pool:
  vmImage: ubuntu-latest

# Steps
steps:

# Install .NET 10 SDK
- task: UseDotNet@2
  inputs:
    packageType: 'sdk'
    version: '10.0.x'  # Use .NET 10 SDK
  displayName: 'Install .NET 10 SDK'

# Restore NuGet packages
- script: dotnet restore SecurePizzaAPI/SecurePizzaAPI.csproj
  displayName: 'Restore NuGet packages'

# Build the main project
- script: dotnet build SecurePizzaAPI/SecurePizzaAPI.csproj --configuration Release
  displayName: 'Build main project'

# Run unit tests
- script: dotnet test SecurePizzaAPI.Tests/SecurePizzaAPI.Tests.csproj --configuration Release --no-build --verbosity normal
  displayName: 'Run unit tests for SecurePizzaAPI.Tests'

# Publish app for Docker
- script: dotnet publish SecurePizzaAPI/SecurePizzaAPI.csproj --configuration Release --output $(Build.ArtifactStagingDirectory)/publish
  displayName: 'Publish app for Docker'

# SCA: Scan Docker image for vulnerabilities (example with Trivy)
- task: Trivy@1
  inputs:
    image: 'ottowski/securepizzaapi:1.0'
    format: 'table'
  displayName: 'Scan Docker image for vulnerabilities (SCA)'

# Docker: Build and push image to Docker Hub
- task: Docker@2
  inputs:
    containerRegistry: 'DockerServiceConnection'  # This matches your service connection name
    repository: 'ottowski/securepizzaapi'
    command: 'buildAndPush'
    Dockerfile: '**/Dockerfile'
    tags: '1.0'
  displayName: 'Build and push Docker image'

# Optional: Deploy to Azure Container Instances or Web App for Containers
# You can add deployment steps here, e.g., using AzureCLI@2 or AzureWebApp@1
